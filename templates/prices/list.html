{% extends "base.html" %}

{% block title %}Управление ценами — Joy Vision Calculator{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-currency-dollar"></i> Управление ценами</h1>
    <div class="btn-group">
        <a href="/prices/import" class="btn btn-primary">
            <i class="bi bi-upload"></i> Импорт из Excel
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Прайс-лист</h5>
        <div class="d-flex gap-2">
            <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Поиск по артикулу или названию..." style="width: 300px;">
            <select id="category-filter" class="form-select form-select-sm" style="width: 200px;">
                <option value="">Все категории</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        <div id="prices-container">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3">Загрузка прайс-листа...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allPrices = [];
let filteredPrices = [];

// Загрузка цен при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadPrices();

    // Обработчики фильтров
    document.getElementById('search-input').addEventListener('input', filterPrices);
    document.getElementById('category-filter').addEventListener('change', filterPrices);
});

function loadPrices() {
    fetch('/api/prices')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allPrices = data.data;
                filteredPrices = [...allPrices];
                populateCategoryFilter();
                renderPrices();
            } else {
                showError('Ошибка загрузки прайс-листа: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Произошла ошибка при загрузке прайс-листа');
        });
}

function populateCategoryFilter() {
    const categories = [...new Set(allPrices.map(p => p.category).filter(c => c))];
    const select = document.getElementById('category-filter');

    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
    });
}

function filterPrices() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const selectedCategory = document.getElementById('category-filter').value;

    filteredPrices = allPrices.filter(price => {
        const matchesSearch = !searchTerm ||
            price.article.toLowerCase().includes(searchTerm) ||
            price.name.toLowerCase().includes(searchTerm);

        const matchesCategory = !selectedCategory || price.category === selectedCategory;

        return matchesSearch && matchesCategory;
    });

    renderPrices();
}

function renderPrices() {
    const container = document.getElementById('prices-container');

    if (filteredPrices.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i>
                ${allPrices.length === 0 ? 'Прайс-лист пуст. Импортируйте данные из Excel.' : 'Ничего не найдено. Попробуйте изменить параметры поиска.'}
            </div>
        `;
        return;
    }

    const tableHTML = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Артикул</th>
                        <th>Наименование</th>
                        <th>Единица</th>
                        <th>Категория</th>
                        <th class="text-end">Цена</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredPrices.map(price => `
                        <tr>
                            <td><code>${price.article}</code></td>
                            <td>${price.name}</td>
                            <td>${price.unit || '—'}</td>
                            <td>
                                ${price.category ? `<span class="badge bg-secondary">${price.category}</span>` : '—'}
                            </td>
                            <td class="text-end">
                                <strong>${formatPrice(price.price)}</strong>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="text-muted small mt-2">
            Показано записей: ${filteredPrices.length} из ${allPrices.length}
        </div>
    `;

    container.innerHTML = tableHTML;
}

function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 2
    }).format(price || 0);
}

function showError(message) {
    document.getElementById('prices-container').innerHTML = `
        <div class="alert alert-danger">
            <h5>Ошибка</h5>
            <p>${message}</p>
        </div>
    `;
}
</script>
{% endblock %}
