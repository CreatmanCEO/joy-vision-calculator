# Тест-план

**Проект**: Joy Vision Calculator
**Дата**: 2026-02-20
**Версия**: 1.0

---

## 1. Обзор

### 1.1 Цель тестирования
Обеспечить корректность расчётов комплектующих и стабильность работы приложения.

### 1.2 Область тестирования

| Модуль | Приоритет | Тип тестов |
|--------|-----------|------------|
| Calculator | Высокий | Unit, Integration |
| Orders API | Высокий | Integration, E2E |
| PDF Generation | Средний | Integration |
| Pricing | Средний | Unit, Integration |
| Bitrix API | Низкий | Integration (mock) |

---

## 2. Тестирование калькулятора

### 2.1 Unit-тесты расчёта

Каждая система должна быть протестирована на граничных значениях.

**Slider L / Slider X**:
| Тест | Входные данные | Ожидаемый результат |
|------|----------------|---------------------|
| Минимум 2 створки | width=2000, height=2000, panels=2 | Расчёт без ошибок |
| Максимум 5 створок | width=5000, height=3000, panels=5 | 5 дорожек |
| Открывание от центра | opening="от центра", panels=4 | Магнитный уплотнитель |
| Тяжёлая створка | glass_weight > 90 кг | Дополнительные ролики |
| Без бокового профиля | left_edge="без профиля" | Другой зазор |

**JV Line**:
| Тест | Входные данные | Ожидаемый результат |
|------|----------------|---------------------|
| 2 створки | panels=2 | Парковка рассчитана |
| 5 створок | panels=5 | Глубина парковки больше |
| Замок в пол | floor_lock=True | LN-230 в комплектации |

**JV Zig-Zag**:
| Тест | Входные данные | Ожидаемый результат |
|------|----------------|---------------------|
| 1.5 створки | panels=1.5 | Половинчатая створка |
| 4.5 створки | panels=4.5 | Корректный расчёт |
| Целое число | panels=3 | Ошибка валидации |

### 2.2 Проверка формул

Сравнение результатов с Excel-калькулятором:
1. Взять 10 реальных заказов из Excel
2. Прогнать через API `/api/calculate`
3. Сравнить все комплектующие

**Допустимая погрешность**: 0 (точное совпадение)

---

## 3. Тестирование API

### 3.1 CRUD заказов

| Тест | Метод | URL | Ожидание |
|------|-------|-----|----------|
| Создание заказа | POST | /api/orders | 201, id возвращён |
| Получение заказа | GET | /api/orders/1 | 200, данные корректны |
| Обновление заказа | PUT | /api/orders/1 | 200, изменения сохранены |
| Удаление заказа | DELETE | /api/orders/1 | 200, заказ удалён |
| Несуществующий заказ | GET | /api/orders/999 | 404 |

### 3.2 Системы в заказе

| Тест | Описание | Ожидание |
|------|----------|----------|
| Добавление системы | POST /api/orders/1/systems | Расчёт выполнен |
| Позиция автоинкремент | Добавить 3 системы | positions = 1, 2, 3 |
| Удаление средней | DELETE position=2 | Позиции не перенумеруются |
| Пересчёт суммы | После добавления | total_price обновлён |

### 3.3 Валидация

| Тест | Входные данные | Ожидание |
|------|----------------|----------|
| Пустое имя заказчика | customer_name="" | 400, ошибка |
| Ширина < 0 | width=-100 | 400, ошибка |
| Неверный тип системы | system_type="Unknown" | 400, ошибка |
| Дробные створки для Slider | panels=2.5 | 400, ошибка |

---

## 4. Тестирование PDF

### 4.1 Генерация КП

| Тест | Проверка |
|------|----------|
| Файл создаётся | HTTP 200, Content-Type: application/pdf |
| Имя файла | Content-Disposition содержит "KP_42.pdf" |
| Содержимое | PDF открывается, данные корректны |

### 4.2 Генерация разблюдовки

| Тест | Проверка |
|------|----------|
| Несколько систем | Все системы в таблице |
| Итого по строкам | Суммы корректны |
| Кириллица | Шрифт DejaVuSans, текст читаем |

---

## 5. Тестирование цен

### 5.1 CRUD прайса

| Тест | Ожидание |
|------|----------|
| Добавление позиции | article уникален |
| Обновление цены | updated_at обновлён |
| Импорт из Excel | Позиции созданы/обновлены |

### 5.2 Расчёт стоимости

| Тест | Проверка |
|------|----------|
| Цена системы | Сумма (qty × price) для всех позиций |
| Скидка | total_price = сумма × (1 - discount/100) |

---

## 6. Интеграционные тесты

### 6.1 Сценарий создания заказа

```
1. POST /api/orders → создать заказ
2. POST /api/orders/1/systems → добавить Slider L
3. POST /api/orders/1/systems → добавить JV Line
4. GET /api/orders/1 → проверить total_price
5. GET /api/orders/1/pdf/kp → скачать КП
6. GET /api/orders/1/pdf/spec → скачать разблюдовку
```

### 6.2 Сценарий импорта цен

```
1. Подготовить Excel с 10 позициями
2. POST /api/prices/import
3. Проверить: 10 позиций в БД
4. Изменить цену в Excel
5. POST /api/prices/import
6. Проверить: цена обновлена, updated_at изменён
```

---

## 7. Нагрузочное тестирование

### 7.1 Метрики

| Метрика | Целевое значение |
|---------|------------------|
| Время ответа API | < 500 мс |
| Генерация PDF | < 5 сек |
| Одновременные пользователи | 10 |

### 7.2 Инструменты
- Apache Bench (`ab`)
- Locust

---

## 8. Регрессионное тестирование

При каждом изменении калькулятора:
1. Запустить все unit-тесты
2. Сравнить с эталонными расчётами из Excel
3. Проверить генерацию PDF

---

## 9. Чек-лист приёмки

- [ ] Все 4 системы рассчитываются корректно
- [ ] Заказы создаются/редактируются/удаляются
- [ ] PDF КП генерируется
- [ ] PDF разблюдовки генерируется
- [ ] Цены импортируются из Excel
- [ ] Интеграция с Битрикс работает
- [ ] UI отображается корректно в Chrome/Firefox
