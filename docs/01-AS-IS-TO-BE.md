# Анализ текущего состояния и план развития

**Проект**: Калькулятор безрамного остекления Hans
**Дата**: 2026-02-20
**Версия документа**: 1.0

---

## 1. Текущее состояние (AS-IS)

### 1.1 Существующие компоненты

| Компонент | Путь | Статус | Описание |
|-----------|------|--------|----------|
| Калькулятор комплектующих | `C:\Hans\calculator.py` | Работает | Расчёт для 4 систем: Slider L/X, JV Line, Zig-Zag |
| Старая версия (tkinter) | `C:\Hans\old\` | Работает | Интеграция с Битрикс24, UI на tkinter |
| Новая версия (Flask) | `C:\Hans\new\` | Заглушки | Веб-интерфейс, API не реализован |
| Генератор PDF | `C:\Hans\Разблюдовка_KP\reader_0.2.py` | Работает | Разблюдовка из Excel, reportlab |
| Excel расчётник | `C:\Hans\JV-комплектация 27.02.2025.xlsm` | Работает | Источник истины для расчётов и цен |

### 1.2 Интеграция с Битрикс24

**Что работает**:
- Создание сделок (`crm.deal.add`)
- Загрузка JSON-файла в сделку (`UF_CRM_1747739451`)
- Загрузка файлов на диск (`disk.folder.uploadfile`)

**Что НЕ работает**:
- Обратное чтение JSON из сделки (проблема с публичными ссылками)
- Передача структурированных данных заказа

### 1.3 Проблемы текущего решения

1. **Разрозненность**: Калькулятор, UI и PDF-генератор — отдельные несвязанные файлы
2. **Нет БД**: Заказы хранятся в JSON-файлах локально
3. **Нет веб-доступа**: tkinter работает только на одном ПК
4. **Нет управления ценами**: Цены только в Excel
5. **Нет масштабирования**: Невозможно работать нескольким пользователям

---

## 2. Целевое состояние (TO-BE)

### 2.1 Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                        Браузер                               │
│  (Chrome/Firefox/Safari)                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Flask Application                         │
│  ┌─────────────┬─────────────┬─────────────┬──────────────┐ │
│  │  Calculator │   Orders    │     PDF     │   Pricing    │ │
│  │   Module    │   Module    │   Module    │   Module     │ │
│  └─────────────┴─────────────┴─────────────┴──────────────┘ │
│                              │                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              SQLAlchemy ORM                             ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│   SQLite (разработка)   │     │  PostgreSQL (продакшн)  │
└─────────────────────────┘     └─────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │        Битрикс24 API          │
              │   (синхронизация сделок)      │
              └───────────────────────────────┘
```

### 2.2 Функциональные требования

| ID | Функция | Приоритет | Описание |
|----|---------|-----------|----------|
| F1 | Расчёт комплектующих | Высокий | 4 системы, все параметры |
| F2 | Управление заказами | Высокий | CRUD, несколько систем в заказе |
| F3 | Генерация PDF КП | Высокий | Коммерческое предложение |
| F4 | Генерация PDF разблюдовки | Высокий | Комплектация для склада |
| F5 | Управление ценами | Средний | CRUD, импорт из Excel |
| F6 | Синхронизация с Битрикс24 | Средний | Создание/обновление сделок |
| F7 | Авторизация | Низкий | Пользователи, роли |
| F8 | Интеграция с Tilda | Низкий | iframe/API для сайта |

### 2.3 Нефункциональные требования

| ID | Требование | Значение |
|----|------------|----------|
| NF1 | Одновременные пользователи | 1-3 (начально), до 10 (масштабирование) |
| NF2 | Время ответа API | < 500ms |
| NF3 | Генерация PDF | < 5 секунд |
| NF4 | Хостинг | Локально → VPS |
| NF5 | БД | SQLite → PostgreSQL |

---

## 3. План миграции

### Фаза 1: MVP (2-3 недели)
- [ ] Структура проекта
- [ ] Модели БД (Order, System, Price)
- [ ] Интеграция calculator.py
- [ ] API для расчёта
- [ ] Базовый веб-интерфейс

### Фаза 2: PDF и цены (1-2 недели)
- [ ] Генерация PDF КП
- [ ] Генерация PDF разблюдовки
- [ ] CRUD для прайс-листа
- [ ] Импорт цен из Excel

### Фаза 3: Битрикс интеграция (1 неделя)
- [ ] Синхронизация сделок
- [ ] Привязка заказов к сделкам

### Фаза 4: Продакшн (1 неделя)
- [ ] Миграция на PostgreSQL
- [ ] Деплой на VPS
- [ ] Базовая авторизация

---

## 4. Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Сложность интеграции с Битрикс | Средняя | Среднее | Локальное хранение как fallback |
| Ошибки в расчётах | Низкая | Высокое | Unit-тесты на calculator |
| Масштабирование SQLite | Низкая | Среднее | WAL mode, миграция на PostgreSQL |

---

## 5. Согласование

| Роль | ФИО | Дата | Подпись |
|------|-----|------|---------|
| Заказчик | | | |
| Разработчик | | | |
